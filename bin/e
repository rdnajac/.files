#!/usr/bin/env bash

TMUX_PANE_NAME="nnn_visual"
NNN_SPLITSIZE=${NNN_SPLITSIZE:-80}
NVIM_SOCK=${NVIM_SOCK:-$HOME/.cache/nvim/server.pipe}

main() {
	if [ "$NVIM" != "" ]; then
		echo "NVIM is set. exiting..."
		exit 1
	fi

	if [ -S "$NVIM_SOCK" ]; then
		# shellcheck disable=SC2154
		if [ "$nnn" != "" ]; then
			env NVIM_APPNAME=vim nvim --server "$NVIM_SOCK" --remote "$@"
		else
			env NVIM_APPNAME=vim nvim --server "$NVIM_SOCK" --remote "$(realpath "$1")"
		fi
		exit 0
	fi

	if [ "$TMUX" != "" ]; then
		if tmux list-panes -F '#T' | grep -q "^$TMUX_PANE_NAME$"; then
			local pane_id
			pane_id=$(tmux list-panes -F '#{pane_id}:#{pane_title}' | grep "$TMUX_PANE_NAME" | cut -d: -f1)
			tmux send-keys -t "$pane_id" Escape ":e $*" Enter
		else
			tmux split-window -h -p "$NNN_SPLITSIZE" "env NVIM_APPNAME=vim nvim $*"
			tmux select-pane -T "$TMUX_PANE_NAME"
		fi
	else
		env NVIM_APPNAME=vim nvim "$@"
	fi
}

main "$@"
